<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>EverMeds Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#0078ff;
      --bg1:#dbeafe; --bg2:#fef9c3;
      --card:#ffffff; --bot:#f1f5f9;
      --text:#111; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; margin: 0; padding: 16px;
    }
    #chatbox {
      width: 420px; max-width: 100%; height: 80vh;
      background: var(--card); border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.12);
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    #header {
      padding: 12px; background: var(--brand); color:#fff; font-weight: 600;
      display:flex; justify-content: space-between; align-items:center;
    }
    #clear { background: rgba(255,255,255,0.2); border:none; color:#fff;
      padding:6px 12px; border-radius:8px; cursor:pointer; }
    #clear:hover{ background: rgba(255,255,255,0.35); }
    #log {
      flex:1; padding: 14px; overflow-y: auto; display:flex; flex-direction:column; gap:12px;
      background:#fafafa;
    }
    .row { display:flex; flex-direction:column; max-width: 85%; animation: fade .25s ease; }
    .row.user { align-self: flex-end; text-align: right; }
    .row.bot  { align-self: flex-start; text-align: left; }
    .msg { padding: 10px 14px; border-radius: 18px; line-height: 1.45; word-wrap: break-word; white-space: pre-wrap; }
    .row.user .msg { background: var(--brand); color:#fff; border-bottom-right-radius: 6px; }
    .row.bot  .msg { background: var(--bot); color:var(--text); border-bottom-left-radius: 6px; }
    .time { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .avatar { font-size: 20px; margin-bottom: 4px; }
    .sources { font-size: 12px; margin-top: 6px; }
    .sources a { color: #2563eb; text-decoration: none; }
    .sources a:hover { text-decoration: underline; }
    #inputArea { display:flex; border-top:1px solid #eee; padding:10px; gap:8px; background:#fff; }
    #txt { flex:1; border:1px solid #ddd; border-radius: 10px; padding:10px; resize: none; min-height:42px; max-height:140px; }
    #send { background: var(--brand); color:#fff; border:none; padding:0 16px; border-radius: 10px; cursor:pointer; }
    #send:hover { background:#055bcc; }
    #scrollBtn { display:none; position:absolute; bottom:90px; right:16px; background:var(--brand); color:#fff;
      border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,.25);}
    #footerNote { font-size: 11px; color: var(--muted); text-align:center; padding: 6px 0 10px; }
    @keyframes fade{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <div id="chatbox">
    <div id="header">
      <span>ðŸ’¬ EverMeds Assistant</span>
      <button id="clear">Clear</button>
    </div>
    <div id="log"></div>
    <div id="inputArea">
      <textarea id="txt" placeholder="Ask about delivery, returns, COD, prescription..." autocomplete="off"></textarea>
      <button id="send">Send</button>
    </div>
    <button id="scrollBtn" title="Scroll to bottom">â¬‡</button>
    <div id="footerNote">Info only Â· Not medical advice</div>
  </div>

  <script>
    // Same-origin API on Render (no localhost). Backend provides /ask and /chat.
    // We use /ask (preferred): body {q}, response {answer, citations[]}
    const API = "/ask";

    const log = document.getElementById('log');
    const txt = document.getElementById('txt');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const scrollBtn = document.getElementById('scrollBtn');

    function ts(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    function addBubble(text, who, citations){
      const row = document.createElement('div'); row.className = 'row ' + who;
      const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = (who==='user' ? 'ðŸ™‚' : 'ðŸ¤–');
      const msg = document.createElement('div'); msg.className = 'msg'; msg.innerHTML = (text||'').replace(/\n/g,'<br>');
      const time = document.createElement('div'); time.className = 'time'; time.textContent = ts();
      row.appendChild(avatar); row.appendChild(msg);
      if(citations && citations.length){
        const src = document.createElement('div');
        src.className = 'sources';
        src.innerHTML = 'Sources: ' + citations.map(u => `<a href="${u}" target="_blank" rel="noopener">${u}</a>`).join(' | ');
        row.appendChild(src);
      }
      row.appendChild(time);
      log.appendChild(row); log.scrollTop = log.scrollHeight;
    }

    function typing(on){
      let el = document.getElementById('typing');
      if(on){
        if(!el){
          el = document.createElement('div'); el.id='typing'; el.className='row bot';
          el.innerHTML = `<div class="avatar">ðŸ¤–</div><div class="msg">Typingâ€¦</div><div class="time">${ts()}</div>`;
          log.appendChild(el);
        }
      } else if(el){ el.remove(); }
      log.scrollTop = log.scrollHeight;
    }

    async function sendMessage(){
      const q = (txt.value || '').trim(); if(!q) return;
      addBubble(q, 'user'); txt.value = ''; txt.style.height='42px'; txt.focus();
      typing(true);
      try{
        const r = await fetch(API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({q})
        });
        const j = await r.json();
        typing(false);
        addBubble(j.answer || j.reply || j.error || 'No response', 'bot', j.citations);
      }catch(e){
        typing(false);
        addBubble('Error: '+e.message, 'bot');
      }
    }

    // textarea auto-resize + Enter behavior
    txt.addEventListener('input', () => {
      txt.style.height = 'auto';
      txt.style.height = Math.min(txt.scrollHeight, 140) + 'px';
    });
    txt.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    sendBtn.onclick = sendMessage;
    clearBtn.onclick = () => { log.innerHTML = ''; greet(); };

    function greet(){
      addBubble('Hi! I can help with delivery, returns, COD, prescription upload, and payments.', 'bot');
    }
    greet();

    // scroll button logic
    log.addEventListener('scroll', () => {
      if(log.scrollTop + log.clientHeight < log.scrollHeight - 50){
        scrollBtn.style.display = 'block';
      } else {
        scrollBtn.style.display = 'none';
      }
    });
    scrollBtn.onclick = () => { log.scrollTop = log.scrollHeight; };
  </script>
</body>
</html>
